<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic PWA - MonBudget</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/monbudgetV2/manifest.json">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .check-ok { color: #198754; }
        .check-error { color: #dc3545; }
        .check-warning { color: #ffc107; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; }
        .badge-status { font-size: 0.875rem; }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="mb-4">
            <i class="bi bi-tools"></i>
            Diagnostic PWA - MonBudget
        </h1>

        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Cette page vérifie si votre navigateur et votre configuration supportent l'installation PWA.
        </div>

        <!-- Statut général -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Statut général</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Navigateur :</strong> <span id="browser"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Plateforme :</strong> <span id="platform"></span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <strong>Protocol :</strong> <span id="protocol"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Hostname :</strong> <span id="hostname"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vérifications PWA -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Vérifications PWA</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody id="checks">
                        <!-- Rempli par JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Service Worker -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Service Worker</h5>
            </div>
            <div class="card-body">
                <div id="sw-status"></div>
            </div>
        </div>

        <!-- Manifest -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Manifest</h5>
            </div>
            <div class="card-body">
                <div id="manifest-status"></div>
            </div>
        </div>

        <!-- Console -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Console de logs</h5>
            </div>
            <div class="card-body">
                <pre id="console-logs" style="max-height: 300px; overflow-y: auto;"></pre>
            </div>
        </div>

        <div class="text-center">
            <a href="/monbudgetV2/" class="btn btn-primary">
                <i class="bi bi-arrow-left"></i>
                Retour à l'application
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Logs console
        const logs = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            logs.push({ type: 'log', message: args.join(' '), time: new Date().toISOString() });
            updateConsoleLogs();
            originalLog.apply(console, args);
        };
        console.error = function(...args) {
            logs.push({ type: 'error', message: args.join(' '), time: new Date().toISOString() });
            updateConsoleLogs();
            originalError.apply(console, args);
        };
        console.warn = function(...args) {
            logs.push({ type: 'warn', message: args.join(' '), time: new Date().toISOString() });
            updateConsoleLogs();
            originalWarn.apply(console, args);
        };

        function updateConsoleLogs() {
            const consoleEl = document.getElementById('console-logs');
            consoleEl.textContent = logs.map(l => `[${l.time.substring(11, 19)}] ${l.type.toUpperCase()}: ${l.message}`).join('\n');
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // Détecter le navigateur
        function detectBrowser() {
            const ua = navigator.userAgent;
            if (ua.includes('Edg')) return 'Microsoft Edge';
            if (ua.includes('OPR') || ua.includes('Opera')) return 'Opera';
            if (ua.includes('Chrome')) return 'Google Chrome';
            if (ua.includes('Firefox')) return 'Mozilla Firefox';
            if (ua.includes('Safari')) return 'Safari';
            return 'Inconnu';
        }

        // Vérifications
        const checks = [
            {
                name: 'HTTPS ou Localhost',
                check: () => window.location.protocol === 'https:' || window.location.hostname === 'localhost',
                required: true
            },
            {
                name: 'Service Worker supporté',
                check: () => 'serviceWorker' in navigator,
                required: true
            },
            {
                name: 'Manifest présent',
                check: () => document.querySelector('link[rel="manifest"]') !== null,
                required: true
            },
            {
                name: 'Fetch API supportée',
                check: () => 'fetch' in window,
                required: true
            },
            {
                name: 'Cache API supportée',
                check: () => 'caches' in window,
                required: true
            },
            {
                name: 'Push API supportée',
                check: () => 'PushManager' in window,
                required: false
            },
            {
                name: 'Notifications supportées',
                check: () => 'Notification' in window,
                required: false
            },
            {
                name: 'App déjà installée',
                check: () => window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true,
                required: false
            }
        ];

        // Afficher les infos générales
        document.getElementById('browser').textContent = detectBrowser();
        document.getElementById('platform').textContent = navigator.platform;
        document.getElementById('protocol').innerHTML = window.location.protocol === 'https:' 
            ? '<span class="badge bg-success">HTTPS ✓</span>' 
            : '<span class="badge bg-danger">HTTP</span>';
        document.getElementById('hostname').textContent = window.location.hostname;

        // Exécuter les vérifications
        const checksEl = document.getElementById('checks');
        let allPassed = true;

        checks.forEach(check => {
            const passed = check.check();
            const tr = document.createElement('tr');
            
            const icon = passed ? '<i class="bi bi-check-circle-fill check-ok"></i>' 
                : (check.required ? '<i class="bi bi-x-circle-fill check-error"></i>' 
                    : '<i class="bi bi-exclamation-triangle-fill check-warning"></i>');
            
            tr.innerHTML = `
                <td style="width: 40px;">${icon}</td>
                <td>${check.name}</td>
                <td style="width: 100px;">
                    <span class="badge ${passed ? 'bg-success' : (check.required ? 'bg-danger' : 'bg-warning')} badge-status">
                        ${passed ? 'OK' : (check.required ? 'ERREUR' : 'Non supporté')}
                    </span>
                </td>
            `;
            checksEl.appendChild(tr);

            if (!passed && check.required) {
                allPassed = false;
            }
        });

        // Vérifier le Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                const swStatusEl = document.getElementById('sw-status');
                
                if (registrations.length === 0) {
                    swStatusEl.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Aucun Service Worker enregistré. Tentative d'enregistrement...
                        </div>
                    `;
                    
                    // Tenter d'enregistrer
                    navigator.serviceWorker.register('/monbudgetV2/service-worker.js')
                        .then(reg => {
                            console.log('[Diagnostic] Service Worker enregistré:', reg.scope);
                            swStatusEl.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i>
                                    Service Worker enregistré avec succès !<br>
                                    <small>Scope: ${reg.scope}</small>
                                </div>
                            `;
                        })
                        .catch(err => {
                            console.error('[Diagnostic] Erreur enregistrement SW:', err);
                            swStatusEl.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="bi bi-x-circle"></i>
                                    Erreur lors de l'enregistrement du Service Worker:<br>
                                    <code>${err.message}</code>
                                </div>
                            `;
                        });
                } else {
                    const reg = registrations[0];
                    const state = reg.active ? reg.active.state : 'installing';
                    
                    swStatusEl.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            Service Worker enregistré<br>
                            <small>
                                <strong>Scope:</strong> ${reg.scope}<br>
                                <strong>État:</strong> ${state}<br>
                                <strong>Updating:</strong> ${reg.updating ? 'Oui' : 'Non'}
                            </small>
                        </div>
                    `;
                }
            });
        } else {
            document.getElementById('sw-status').innerHTML = `
                <div class="alert alert-danger">
                    Service Worker non supporté par ce navigateur.
                </div>
            `;
        }

        // Vérifier le manifest
        const manifestLink = document.querySelector('link[rel="manifest"]');
        if (manifestLink) {
            fetch(manifestLink.href)
                .then(r => r.json())
                .then(manifest => {
                    console.log('[Diagnostic] Manifest chargé:', manifest);
                    document.getElementById('manifest-status').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            Manifest chargé avec succès<br>
                            <small>
                                <strong>Nom:</strong> ${manifest.name}<br>
                                <strong>Nom court:</strong> ${manifest.short_name}<br>
                                <strong>Icônes:</strong> ${manifest.icons.length}<br>
                                <strong>Display:</strong> ${manifest.display}<br>
                                <strong>Start URL:</strong> ${manifest.start_url}
                            </small>
                        </div>
                        <details>
                            <summary>Voir le manifest complet</summary>
                            <pre>${JSON.stringify(manifest, null, 2)}</pre>
                        </details>
                    `;
                })
                .catch(err => {
                    console.error('[Diagnostic] Erreur chargement manifest:', err);
                    document.getElementById('manifest-status').innerHTML = `
                        <div class="alert alert-danger">
                            Erreur lors du chargement du manifest:<br>
                            <code>${err.message}</code>
                        </div>
                    `;
                });
        } else {
            document.getElementById('manifest-status').innerHTML = `
                <div class="alert alert-danger">
                    Aucun manifest trouvé dans le HTML.
                </div>
            `;
        }

        // Écouter beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('[Diagnostic] ✅ beforeinstallprompt déclenché !');
            logs.push({ 
                type: 'log', 
                message: '✅ beforeinstallprompt DÉCLENCHÉ - L\'app peut être installée !', 
                time: new Date().toISOString() 
            });
            updateConsoleLogs();
        });

        console.log('[Diagnostic] Page de diagnostic chargée');
    </script>
</body>
</html>
